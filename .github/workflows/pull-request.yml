name: ğŸ§ª Pull Request Tests

on:
  pull_request:
    branches: [ main, develop ]

env:
  NODE_VERSION: '18'

jobs:
  # ğŸ§ª Tests sur Pull Request
  test:
    name: ğŸ§ª Tests & Validation
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ”§ Install dependencies
        run: npm ci
        
      - name: ğŸ“Š Check package dependencies
        run: npm run health-check || true
        
      - name: ğŸ—ï¸ Test build (without database)
        run: npm run ci:build
        
      - name: ğŸ“‹ Generate build report
        run: |
          echo "## ğŸ“Š Build Report" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Build completed successfully" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ“¦ Build artifacts generated in \`dist/\`" >> $GITHUB_STEP_SUMMARY
          
      - name: ğŸ’¬ Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            // Check if dist directory exists and has content
            const buildExists = fs.existsSync('dist') && fs.readdirSync('dist').length > 0;
            
            const comment = buildExists 
              ? `## âœ… Build Success
                 
                 Your changes build successfully! ğŸ‰
                 
                 **Next steps:**
                 - Merge to trigger production deployment
                 - Database setup will be handled automatically
                 - Monitor deployment in Vercel dashboard`
              : `## âŒ Build Issues
                 
                 The build completed but no output was generated.
                 
                 **Troubleshooting:**
                 - Check build logs above
                 - Verify all imports are correct
                 - Ensure no syntax errors`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });